#+title: Asynthe's flakes
#+property: header-args :tangle flake.nix
#+auto_tangle: t

nix build .#hyperv

* Inputs

#+begin_src nix
{
  description = "Minimal nixOS flake";
#+end_src

Inputs
#+begin_src nix
inputs = {
  nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
  nixpkgs-stable.url = "github:nixos/nixpkgs/nixos-23.11";
  impermanence.url = "github:nix-community/impermanence";
  sops-nix.url = "github:Mic92/sops-nix";
  disko = {
    url = "github:nix-community/disko";
    inputs.nixpkgs.follows = "nixpkgs";
  };
  nixos-generators = {
    url = "github:nix-community/nixos-generators";
    inputs.nixpkgs.follows = "nixpkgs";
  };
};
#+end_src

* Outputs

#+begin_src nix
outputs = inputs @ {
    self,
    nixpkgs,
    nixpkgs-stable,
    disko,
    impermanence,
    sops-nix,
    nixos-generators,
}:
{
#+end_src

** Images

#+begin_src nix
packages.x86_64-linux = {
#+end_src

*** Test

#+begin_src nix
qcow = nixos-generators.nixosGenerate {
  system = "x86_64-linux";
  format = "qcow-efi";
  specialArgs = { inherit
    inputs
    ;
    hostname = "user";
  };
  modules = [
    ./hosts/server-vm
    disko.nixosModules.disko
    impermanence.nixosModules.impermanence
  ];
};

vbox = nixos-generators.nixosGenerate {
  system = "x86_64-linux";
  format = "vbox";
  specialArgs = { inherit
    inputs
    ;
    hostname = "user";
  };
  modules = [
    ./hosts/server-vm
    disko.nixosModules.disko
    impermanence.nixosModules.impermanence
  ];
};
#+end_src

*** Closing bracket

#+begin_src nix
};
#+end_src

** Machines

#+begin_src nix
nixosConfigurations = {
#+end_src

** Basic

Copied from my personal configuration, just to test stuff.

#+begin_src nix
      server = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = { inherit
          inputs
          ;
          hostname = "server";
        };
        modules = [
          ./hosts/linux/server
          disko.nixosModules.disko
          impermanence.nixosModules.impermanence
        ];
      };
#+end_src

** Red Team

#+begin_src nix
redteam = nixpkgs.lib.nixosSystem {
  system = "x86_64-linux";
  #format = "all" # How to do this?
  specialArgs = { inherit
    inputs
    ;
    hostname = "redteam";
  };
  modules = [
    ./hosts/linux/server
    disko.nixosModules.disko
    impermanence.nixosModules.impermanence
  ];
};
#+end_src

** Blue Team

#+begin_src nix
blueteam = nixpkgs.lib.nixosSystem {
  system = "x86_64-linux";
  #format = "all" # How to do this?
  specialArgs = { inherit
    inputs
    ;
    hostname = "blueteam";
  };
  modules = [
    ./hosts/hyperv
    disko.nixosModules.disko
    impermanence.nixosModules.impermanence
  ];
};

#+end_src

** Hyper-V

#+begin_src nix
hyperv = nixpkgs.lib.nixosSystem {
  system = "x86_64-linux";
  format = "hyperv";
  specialArgs = { inherit
    inputs
    ;
    hostname = "hyperv";
  };
  modules = [
    ./hosts/hyperv
    disko.nixosModules.disko
    impermanence.nixosModules.impermanence
  ];
};
#+end_src

** Closing Brackets

#+begin_src nix
    };
  };
}
#+end_src
